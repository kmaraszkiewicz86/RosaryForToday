<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:RosaryForToday.Presentation.Converters"
             x:Class="RosaryForToday.Presentation.Views.RosaryListView"
             x:Name="Root"
             Title="Różanniec na dzisiaj">

    <ContentPage.Resources>

        <converters:BoolToIsVisibleConverter x:Key="BoolToIsVisible" />

        <DataTemplate x:Key="RosaryItemTemplate">
            <Border Margin="10" Padding="10" Stroke="#555" Background="#444">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="6"/>
                </Border.StrokeShape>

                <VerticalStackLayout Spacing="6">
                    <Label Text="{Binding RosaryTypeName}" FontAttributes="Bold" FontSize="18" />
                    <Label Text="{Binding DayOfWeek}" FontSize="18" TextColor="Gray" />

                    <!-- Compact list of reflections (titles only) for quick glance -->
                    <CollectionView ItemsSource="{Binding RosaryReflections}" SelectionMode="None" ItemsLayout="VerticalList">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Label Text="{Binding Title}" FontSize="14" TextColor="White" Margin="4,2" />
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Toggle button to show/hide full descriptions -->
                    <Button Text="{Binding ButtonName}" HorizontalOptions="End"
                            Command="{Binding ToggleDetailsCommand}" />

                    <!-- Collapsible detailed reflections (titles + content) -->
                    <CollectionView IsVisible="{Binding ShowDetails}" ItemsSource="{Binding RosaryReflections}" ItemsLayout="VerticalList">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <VerticalStackLayout Grid.Column="1">
                                        <Grid ColumnDefinitions="*, Auto">
                                            <Label Grid.Column="0" 
                                                   Text="{Binding Title}" 
                                                   FontSize="16" />
                                            <Button Grid.Column="1" 
                                                    Text="{Binding ButtonName}"
                                                    Command="{Binding ToggleDetailsCommand}" 
                                                    Margin="8,0" />
                                        </Grid>
                                        <Label Text="{Binding Content}" 
                                               IsVisible="{Binding ShowDetails, Converter={StaticResource BoolToIsVisible}}"
                                                FontAttributes="Italic" 
                                               FontSize="16" 
                                               TextColor="Gray" />
                                    </VerticalStackLayout>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                </VerticalStackLayout>
            </Border>
        </DataTemplate>
    </ContentPage.Resources>

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Odśwież" Order="Primary" Priority="0"
                     Command="{Binding RefreshCommand}" />
    </ContentPage.ToolbarItems>

    <ContentPage.Content>
        <Grid RowDefinitions="Auto, *">
            <StackLayout Grid.Row="0">
                <Label Text="{Binding ErrorMessage}"
                       TextColor="Red"
                       FontAttributes="Bold"
                       Margin="12,8,12,0">
                    <Label.Triggers>
                        <DataTrigger TargetType="Label" Binding="{Binding ErrorMessage}" Value="{x:Null}">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                        <DataTrigger TargetType="Label" Binding="{Binding ErrorMessage}" Value="">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                    </Label.Triggers>
                </Label>

                <!-- Simple tab buttons -->
                <Grid ColumnDefinitions="*,*" Padding="8,6,8,6">
                    <Button Grid.Column="0" Text="Dzisiaj" Command="{Binding ShowTodayCommand}" Margin="5" />
                    <Button Grid.Column="1" Text="Wszystkie" Command="{Binding ShowAllCommand}" Margin="5" />
                </Grid>
            </StackLayout>

            <!-- Two CollectionViews: one for today's Items, one for AllItems. Visibility toggled by ViewModel.ShowAllItems -->
            <Grid Grid.Row="1">
                <!-- Today's single item view -->
                <CollectionView ItemsSource="{Binding Items}" SelectionMode="None" ItemTemplate="{StaticResource RosaryItemTemplate}">
                    <CollectionView.Triggers>
                        <DataTrigger TargetType="CollectionView" Binding="{Binding ShowAllItems}" Value="True">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                    </CollectionView.Triggers>
                </CollectionView>

                <!-- All items view -->
                <CollectionView ItemsSource="{Binding AllItems}" SelectionMode="None" ItemTemplate="{StaticResource RosaryItemTemplate}" IsVisible="{Binding ShowAllItems}">
                </CollectionView>
            </Grid>
        </Grid>
    </ContentPage.Content>

</ContentPage>